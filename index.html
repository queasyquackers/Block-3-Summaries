<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Study OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&family=Merriweather:wght@700;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['Georgia', 'Cambria', 'Times New Roman', 'serif'],
                        display: ['Merriweather', 'Georgia', 'serif'],
                    },
                    colors: {
                        solarized: {
                            base3: '#fdf6e3', base2: '#eee8d5', base1: '#93a1a1',
                            base0: '#839496', base00: '#657b83', base01: '#586e75',
                            yellow: '#b58900', orange: '#cb4b16', red: '#dc322f',
                            magenta: '#d33682', violet: '#6c71c4', blue: '#268bd2',
                            cyan: '#2aa198', green: '#859900',
                        },
                        dark: {
                            bg: '#0f0e1a', surface: '#181625', border: '#2a273f',
                            text: '#e0def4', muted: '#908caa', accent: '#6c71c4', hover: '#2d2b42',
                        }
                    }
                }
            }
        }
    </script>
    <script src="lectures_data.js"></script>
    <style>
        * {
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #eee8d5;
        }

        .dark ::-webkit-scrollbar-track {
            background: #181625;
        }

        ::-webkit-scrollbar-thumb {
            background: #93a1a1;
            border-radius: 5px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #2a273f;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .animate-in {
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ripple-container {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0);
            animation: ripple 0.6s linear;
        }

        .frosted {
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
        }

        .gradient-overlay {
            background: linear-gradient(135deg, rgba(38, 139, 210, 0.05) 0%, rgba(42, 161, 152, 0.05) 100%);
        }

        .dark .gradient-overlay {
            background: linear-gradient(135deg, rgba(108, 113, 196, 0.08) 0%, rgba(42, 39, 63, 0.08) 100%);
        }

        .glow-focus:focus {
            box-shadow: 0 0 0 3px rgba(38, 139, 210, 0.3);
        }

        .dark .glow-focus:focus {
            box-shadow: 0 0 0 3px rgba(108, 113, 196, 0.3);
        }

        .glossary-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glossary-hover:hover {
            transform: translateX(4px) scale(1.01);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        #readingProgress {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #268bd2, #2aa198);
            z-index: 9999;
            transition: width 0.1s ease;
        }

        .dark #readingProgress {
            background: linear-gradient(90deg, #6c71c4, #268bd2);
        }

        #tableOfContents {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .toc-link {
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
        }

        .toc-link:hover {
            border-left-color: #268bd2;
            background: rgba(38, 139, 210, 0.1);
        }

        .dark .toc-link:hover {
            border-left-color: #6c71c4;
            background: rgba(108, 113, 196, 0.1);
        }

        .module-card-cardiovascular {
            border-left-color: #dc322f !important;
        }

        .module-card-respiratory {
            border-left-color: #268bd2 !important;
        }

        .module-card-renal {
            border-left-color: #2aa198 !important;
        }

        .module-card-gi {
            border-left-color: #b58900 !important;
        }

        .module-card-neuro {
            border-left-color: #6c71c4 !important;
        }

        .module-card-endo {
            border-left-color: #859900 !important;
        }

        .module-card-heme {
            border-left-color: #d33682 !important;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #268bd2;
            top: -10px;
            z-index: 9999;
            animation: confetti-fall 3s linear forwards;
        }
    </style>
</head>

<body class="bg-solarized-base3 dark:bg-dark-bg font-serif text-solarized-base00 dark:text-dark-muted">
    <div id="readingProgress" style="width: 0%"></div>

    <div class="flex h-screen">
        <div id="sidebar"
            class="w-80 border-r border-solarized-base2 dark:border-dark-border bg-solarized-base2/95 dark:bg-dark-surface/95 flex flex-col shadow-2xl frosted">
            <div class="p-6 border-b border-solarized-base1/20 dark:border-dark-border gradient-overlay">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-bold text-solarized-blue dark:text-dark-accent tracking-tight font-sans">
                        MedSchool</h1>
                    <button id="darkModeToggle"
                        class="p-2 rounded-lg hover:bg-solarized-base3 dark:hover:bg-dark-hover transition-all duration-300 ripple-container">
                        <svg class="w-5 h-5 text-solarized-base01 dark:text-dark-text transition-transform duration-300 hover:rotate-180"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                </div>
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-solarized-base1 dark:text-dark-muted transition-colors duration-300"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24" id="searchIcon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search lectures... (Press /)"
                        class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-solarized-base1/30 dark:border-dark-border bg-solarized-base3 dark:bg-dark-bg text-solarized-base00 dark:text-dark-text placeholder-solarized-base1 dark:placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-solarized-blue dark:focus:ring-dark-accent font-sans transition-all duration-300 glow-focus" />
                </div>
            </div>
            <div id="lectureList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            <div class="p-4 border-t border-solarized-base1/20 dark:border-dark-border">
                <div class="text-xs text-solarized-base1 dark:text-dark-muted text-center font-sans">
                    <span id="lectureCount">0 lectures</span> loaded
                    <div class="mt-2 text-[10px] opacity-60">üí° Shortcuts: ‚Üê/‚Üí tabs, Esc close, / search</div>
                </div>
            </div>
        </div>

        <div id="mainContent" class="flex-1 flex flex-col bg-solarized-base3 dark:bg-dark-bg overflow-hidden">
            <div id="welcomeScreen" class="flex-1 flex items-center justify-center">
                <div class="text-center animate-in">
                    <div
                        class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-solarized-blue to-solarized-cyan dark:from-dark-accent dark:to-violet-600 flex items-center justify-center shadow-lg transform transition-transform duration-300 hover:scale-110">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-solarized-base01 dark:text-dark-text mb-3 font-sans">Welcome to
                        MedSchool</h2>
                    <p class="text-solarized-base1 dark:text-dark-muted max-w-md mx-auto" id="welcomeMessage">Loading
                        lectures...</p>
                </div>
            </div>

            <div id="lectureContent" class="hidden flex-1 flex flex-col min-h-0">
                <div
                    class="border-b-2 border-solarized-base1/20 dark:border-dark-border bg-solarized-base2/50 dark:bg-dark-surface/50 backdrop-blur-sm gradient-overlay">
                    <div class="p-8 pb-4">
                        <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider bg-solarized-blue/10 dark:bg-dark-accent/10 text-solarized-blue dark:text-dark-accent mb-3 font-sans"
                            id="lectureModule"></div>
                        <h2 id="lectureTitle"
                            class="text-3xl font-bold text-solarized-base01 dark:text-dark-text tracking-tight font-sans">
                        </h2>
                    </div>
                    <div class="px-8 pb-2">
                        <button id="tocToggle"
                            class="hidden ripple-container text-xs px-3 py-1.5 rounded-lg border border-solarized-base1/20 dark:border-dark-border hover:bg-solarized-base3/50 dark:hover:bg-dark-hover text-solarized-base1 dark:text-dark-muted hover:text-solarized-blue dark:hover:text-dark-accent transition-all duration-300 font-sans flex items-center gap-2">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <span>Outline</span>
                        </button>
                    </div>
                </div>

                <div
                    class="flex border-b border-solarized-base1/20 dark:border-dark-border bg-solarized-base2/30 dark:bg-dark-surface/30 px-8 font-sans">
                    <button
                        class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-solarized-blue dark:border-dark-accent text-solarized-blue dark:text-dark-accent transition-all duration-300"
                        data-tab="summary">Summary</button>
                    <button
                        class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-solarized-base1 dark:text-dark-muted hover:text-solarized-base00 dark:hover:text-dark-text transition-all duration-300"
                        data-tab="questions">Questions</button>
                    <button
                        class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-solarized-base1 dark:text-dark-muted hover:text-solarized-base00 dark:hover:text-dark-text transition-all duration-300"
                        data-tab="glossary">Glossary</button>
                    <button
                        class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-solarized-base1 dark:text-dark-muted hover:text-solarized-base00 dark:hover:text-dark-text transition-all duration-300"
                        data-tab="high-yield">High Yield</button>
                </div>

                <div class="flex-1 overflow-y-auto" id="contentScroll">
                    <div class="flex max-w-7xl mx-auto">
                        <div id="tableOfContents"
                            class="hidden w-64 p-6 border-r border-solarized-base1/10 dark:border-dark-border"></div>
                        <div id="tabContent" class="flex-1 p-8"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lectures = window.LECTURES_DATA || [];
        let selectedLecture = null;
        let activeTab = 'summary';
        let isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let showAnswers = false;
        let tocVisible = true;

        document.addEventListener('DOMContentLoaded', function () {
            if (isDark) document.documentElement.classList.add('dark');
            renderLectureList();
            setupEventListeners();
            updateWelcomeMessage();
            setupKeyboardShortcuts();
            setupReadingProgress();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', e => {
                renderLectureList(e.target.value);
                animateSearchIcon();
            });
            document.getElementById('darkModeToggle').addEventListener('click', e => {
                createRipple(e);
                toggleDarkMode();
            });
            document.getElementById('tocToggle').addEventListener('click', e => {
                createRipple(e);
                toggleTableOfContents();
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    createRipple(e);
                    switchTab(this.dataset.tab);
                });
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', e => {
                if (e.key === '/' && document.activeElement.id !== 'searchInput') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                if (e.key === 'Escape' && selectedLecture) {
                    closeLecture();
                }
                if (selectedLecture && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                    const tabs = ['summary', 'questions', 'glossary', 'high-yield'];
                    const currentIndex = tabs.indexOf(activeTab);
                    if (e.key === 'ArrowLeft' && currentIndex > 0) {
                        switchTab(tabs[currentIndex - 1]);
                    } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
                        switchTab(tabs[currentIndex + 1]);
                    }
                }
            });
        }

        function setupReadingProgress() {
            const contentScroll = document.getElementById('contentScroll');
            contentScroll?.addEventListener('scroll', () => {
                const scrollTop = contentScroll.scrollTop;
                const scrollHeight = contentScroll.scrollHeight - contentScroll.clientHeight;
                const progress = (scrollTop / scrollHeight) * 100;
                document.getElementById('readingProgress').style.width = progress + '%';
            });
        }

        function createRipple(e) {
            const button = e.currentTarget;
            if (!button.classList.contains('ripple-container')) {
                button.classList.add('ripple-container');
            }
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            button.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        function animateSearchIcon() {
            const icon = document.getElementById('searchIcon');
            icon.style.transform = 'translate(-50%, -50%) scale(1.2) rotate(15deg)';
            setTimeout(() => icon.style.transform = 'translate(-50%, -50%) scale(1) rotate(0deg)', 200);
        }

        function createConfetti() {
            const colors = ['#268bd2', '#2aa198', '#dc322f', '#b58900', '#6c71c4', '#859900'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.3 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        function toggleDarkMode() {
            isDark = !isDark;
            document.documentElement.classList.toggle('dark');
            if (selectedLecture) renderTabContent();
        }

        function toggleTableOfContents() {
            tocVisible = !tocVisible;
            const toc = document.getElementById('tableOfContents');
            if (tocVisible) {
                toc.classList.remove('hidden');
            } else {
                toc.classList.add('hidden');
            }
        }

        function getModuleClass(module) {
            const moduleLower = module.toLowerCase();
            if (moduleLower.includes('cardio')) return 'module-card-cardiovascular';
            if (moduleLower.includes('resp')) return 'module-card-respiratory';
            if (moduleLower.includes('renal')) return 'module-card-renal';
            if (moduleLower.includes('gi') || moduleLower.includes('gastro')) return 'module-card-gi';
            if (moduleLower.includes('neuro')) return 'module-card-neuro';
            if (moduleLower.includes('endo')) return 'module-card-endo';
            if (moduleLower.includes('heme')) return 'module-card-heme';
            return '';
        }

        function renderLectureList(searchQuery = '') {
            const filtered = lectures.filter(lec => lec.title.toLowerCase().includes(searchQuery.toLowerCase()) || (lec.tags && lec.tags.toLowerCase().includes(searchQuery.toLowerCase())));
            const html = filtered.map(lec => {
                const isActive = selectedLecture?.id === lec.id;
                const moduleClass = getModuleClass(lec.module);
                return `<button onclick="selectLecture('${lec.id}')" class="ripple-container w-full text-left p-4 rounded-xl border-l-4 transition-all duration-300 ${moduleClass} ${isActive ? 'bg-solarized-blue/10 dark:bg-dark-accent/10 border-solarized-blue dark:border-dark-accent shadow-lg scale-[1.02]' : 'border-solarized-base1/20 dark:border-dark-border hover:bg-solarized-base3 dark:hover:bg-dark-hover hover:shadow-md hover:scale-[1.01]'}"><div class="text-xs font-semibold text-solarized-cyan dark:text-dark-accent uppercase tracking-wide mb-1.5 font-sans">${lec.module}</div><div class="font-semibold text-solarized-base01 dark:text-dark-text leading-snug font-sans">${lec.title}</div></button>`;
            }).join('');
            document.getElementById('lectureList').innerHTML = html;
            document.getElementById('lectureCount').textContent = `${lectures.length} lecture${lectures.length !== 1 ? 's' : ''}`;
        }

        function selectLecture(lectureId) {
            selectedLecture = lectures.find(l => l.id === lectureId);
            activeTab = 'summary';
            showAnswers = false;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('lectureContent').classList.remove('hidden');
            document.getElementById('lectureModule').textContent = selectedLecture.module;
            document.getElementById('lectureTitle').textContent = selectedLecture.title;
            switchTab('summary');
            renderLectureList();
            document.getElementById('contentScroll').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function closeLecture() {
            selectedLecture = null;
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('lectureContent').classList.add('hidden');
            document.getElementById('tocToggle').classList.add('hidden');
            renderLectureList();
        }

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tab;
                btn.className = isActive ? 'tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-solarized-blue dark:border-dark-accent text-solarized-blue dark:text-dark-accent transition-all duration-300 shadow-inner' : 'tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-solarized-base1 dark:text-dark-muted hover:text-solarized-base00 dark:hover:text-dark-text transition-all duration-300';
            });
            renderTabContent();
            document.getElementById('contentScroll').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderTabContent() {
            const content = document.getElementById('tabContent');
            const toc = document.getElementById('tableOfContents');
            const tocToggle = document.getElementById('tocToggle');

            setTimeout(() => content.classList.add('fade-in'), 10);

            if (activeTab === 'summary') {
                content.innerHTML = renderMarkdown(selectedLecture.summary);
                generateTableOfContents();
                if (tocVisible) toc.classList.remove('hidden');
                tocToggle.classList.remove('hidden');
            } else {
                toc.classList.add('hidden');
                tocToggle.classList.add('hidden');

                if (activeTab === 'questions') {
                    content.innerHTML = '<button onclick="toggleAnswers()" class="ripple-container mb-8 px-6 py-3 bg-solarized-blue dark:bg-dark-accent text-white rounded-xl hover:shadow-lg font-semibold font-sans transition-all duration-300 hover:scale-105">' + (showAnswers ? 'Hide' : 'Reveal') + ' Answers</button>' + renderMarkdown(selectedLecture.questions);
                } else if (activeTab === 'glossary') {
                    const glossaryHtml = selectedLecture.glossary?.map(item => '<div class="glossary-hover border-l-4 border-solarized-cyan dark:border-dark-accent pl-6 py-5 rounded-r-xl bg-solarized-base2/50 dark:bg-dark-surface/50 shadow-sm"><div class="font-bold text-xl text-solarized-base01 dark:text-dark-text mb-2 font-sans">' + item.term + '</div><div class="text-base text-solarized-base00 dark:text-dark-muted leading-relaxed font-serif">' + item.definition + '</div></div>').join('') || '<p class="text-solarized-base1 dark:text-dark-muted font-serif">No glossary available.</p>';
                    content.innerHTML = '<div class="space-y-4">' + glossaryHtml + '</div>';
                } else if (activeTab === 'high-yield') {
                    const pdfName = selectedLecture.id.toUpperCase() + '_HighYield_Render.pdf';
                    content.innerHTML = '<div class="flex-none p-6 bg-solarized-base2/50 dark:bg-dark-surface/50 border-b border-solarized-base1/20 dark:border-dark-border"><h3 class="text-xl font-bold text-solarized-base01 dark:text-dark-text mb-1 font-sans">High-Yield Slides</h3><p class="text-sm text-solarized-base1 dark:text-dark-muted font-serif">Essential slides from ' + selectedLecture.title + '</p></div><iframe src="' + pdfName + '" class="flex-1 w-full h-screen border-0" title="High Yield Slides PDF"></iframe>';
                }
            }

            setTimeout(() => content.classList.remove('fade-in'), 400);
        }

        function generateTableOfContents() {
            const content = document.getElementById('tabContent');
            const toc = document.getElementById('tableOfContents');

            const partHeadings = Array.from(content.querySelectorAll('h2')).filter(h => h.textContent.match(/^Part\s+\d+/i));
            const clinicalBlocks = content.querySelectorAll('[class*="clinical"]');

            if (partHeadings.length === 0 && clinicalBlocks.length === 0) {
                toc.classList.add('hidden');
                document.getElementById('tocToggle').classList.add('hidden');
                return;
            }

            let tocHtml = '<div class="text-xs font-semibold text-solarized-base1 dark:text-dark-muted uppercase tracking-wider mb-4 font-sans">Outline</div>';

            partHeadings.forEach((heading, index) => {
                const text = heading.textContent;
                heading.id = 'part-' + index;
                tocHtml += `<a href="#part-${index}" class="toc-link block py-2 px-3 text-sm font-semibold text-solarized-violet dark:text-dark-accent hover:text-solarized-blue dark:hover:text-violet-300 font-display" onclick="event.preventDefault(); document.getElementById('part-${index}').scrollIntoView({behavior: 'smooth', block: 'start'})">${text}</a>`;
            });

            if (clinicalBlocks.length > 0 && partHeadings.length > 0) {
                tocHtml += '<div class="h-px bg-solarized-base1/20 dark:bg-dark-border my-3"></div>';
            }

            clinicalBlocks.forEach((block, index) => {
                const firstPara = block.querySelector('p');
                if (firstPara) {
                    const text = firstPara.textContent.substring(0, 40) + '...';
                    block.id = 'clinical-' + index;
                    tocHtml += `<a href="#clinical-${index}" class="toc-link block py-2 px-3 ml-2 text-sm text-solarized-red dark:text-red-400 hover:text-solarized-orange dark:hover:text-orange-400 font-serif flex items-center gap-2" onclick="event.preventDefault(); document.getElementById('clinical-${index}').scrollIntoView({behavior: 'smooth', block: 'center'})"><svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg><span class="truncate">${text}</span></a>`;
                }
            });

            toc.innerHTML = tocHtml;
        }

        function toggleAnswers() {
            const wasHidden = !showAnswers;
            showAnswers = !showAnswers;
            renderTabContent();
            if (wasHidden && showAnswers) {
                setTimeout(() => createConfetti(), 100);
            }
        }

        function renderMarkdown(text) {
            if (!text) return '';
            let html = text;

            html = html.replace(/\n(\|[^\n]+\|\n)+/g, function (tableMatch) {
                const rows = tableMatch.trim().split('\n').filter(row => row.trim());
                if (rows.length < 2) return tableMatch;
                const headerRow = rows[0], bodyRows = rows.slice(2);
                const headerCells = headerRow.split('|').filter(c => c.trim()).map(c => c.trim());
                let tableHtml = '<div class="overflow-x-auto rounded-xl border ' + (isDark ? 'border-dark-border' : 'border-solarized-base1/30') + ' shadow-md my-6"><table class="min-w-full divide-y ' + (isDark ? 'divide-dark-border' : 'divide-solarized-base1/20') + '"><thead class="' + (isDark ? 'bg-dark-surface' : 'bg-solarized-base2') + '"><tr>';
                headerCells.forEach(cell => tableHtml += '<th class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider font-sans ' + (isDark ? 'text-dark-accent' : 'text-solarized-cyan') + '">' + cell + '</th>');
                tableHtml += '</tr></thead><tbody class="divide-y ' + (isDark ? 'divide-dark-border bg-dark-bg' : 'divide-solarized-base1/10 bg-white') + '">';
                bodyRows.forEach(row => {
                    const cells = row.split('|').filter(c => c.trim()).map(c => c.trim());
                    tableHtml += '<tr class="' + (isDark ? 'hover:bg-dark-surface' : 'hover:bg-solarized-base2/30') + ' transition-colors duration-200">';
                    cells.forEach(cell => {
                        const formatted = cell.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-solarized-base01 dark:text-dark-text">$1</strong>');
                        tableHtml += '<td class="px-6 py-4 text-base leading-relaxed font-serif ' + (isDark ? 'text-dark-muted' : 'text-solarized-base00') + '">' + formatted + '</td>';
                    });
                    tableHtml += '</tr>';
                });
                return tableHtml + '</tbody></table></div>';
            });

            html = html.replace(/:::clinical\n([\s\S]*?):::/g, function (match, content) {
                const lines = content.split('\n').filter(l => l.trim());
                const formatted = lines.map(line => '<p class="mb-2 text-red-900 dark:text-red-200">' + line.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>') + '</p>').join('');
                return '<div class="my-8 p-6 rounded-2xl border-l-4 ' + (isDark ? 'bg-red-900/20 border-red-400' : 'bg-red-50 border-red-500') + ' shadow-md font-serif"><div class="flex items-start gap-3"><svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-red-500 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg><div class="flex-1 font-medium leading-relaxed text-base">' + formatted + '</div></div></div>';
            });

            html = html.replace(/:::slides ([^\n]+)\n([\s\S]*?):::/g, function (match, label, content) {
                const items = content.trim().split('\n').filter(l => l.trim());
                let itemsHtml = '';
                items.forEach(item => {
                    const cleaned = item.replace(/^\*\s*/, '').trim();
                    const formatted = cleaned.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-solarized-base01 dark:text-dark-text">$1</strong>');
                    itemsHtml += '<div class="flex gap-2"><span class="' + (isDark ? 'text-dark-accent' : 'text-solarized-cyan') + '">‚Ä¢</span><span class="text-solarized-base00 dark:text-dark-muted">' + formatted + '</span></div>';
                });
                return '<details class="my-6 group"><summary class="cursor-pointer px-4 py-2.5 rounded-lg border ' + (isDark ? 'bg-dark-surface/50 border-dark-border hover:bg-dark-surface text-dark-accent' : 'bg-solarized-blue/5 border-solarized-blue/20 hover:bg-solarized-blue/10 text-solarized-blue') + ' transition-all duration-300 flex items-center gap-3 font-semibold text-sm list-none font-sans"><svg class="w-4 h-4 flex-shrink-0 transition-transform duration-200 group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><span>Slides ' + label + '</span><svg class="w-4 h-4 ml-auto transform group-open:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></summary><div class="mt-3 ml-4 pl-4 border-l border-solarized-base1/20 dark:border-dark-border text-base font-serif leading-relaxed space-y-2 slide-up">' + itemsHtml + '</div></details>';
            });

            html = html.replace(/^#### (.*$)/gm, (match, title) => '<h4 class="text-xl font-bold mt-6 mb-2 text-solarized-base01 dark:text-dark-text tracking-tight font-sans">' + title + '</h4>');
            html = html.replace(/^### (.*$)/gm, (match, title) => '<h3 class="text-2xl font-bold mt-8 mb-3 text-solarized-base01 dark:text-dark-text tracking-tight font-sans">' + title + '</h3>');
            html = html.replace(/^## (.*$)/gm, function (match, title) {
                if (title.match(/^Part\s+\d+/i)) {
                    const underline = '<div class="h-1 w-24 mb-6 ' + (isDark ? 'bg-dark-accent' : 'bg-solarized-violet') + '"></div>';
                    return '<h2 class="text-4xl font-black mt-12 mb-2 ' + (isDark ? 'text-dark-accent' : 'text-solarized-violet') + ' tracking-tight font-display italic">' + title + '</h2>' + underline;
                }
                return '<h2 class="text-3xl font-bold mt-10 mb-3 text-solarized-base01 dark:text-dark-text tracking-tight font-sans">' + title + '</h2>';
            });
            html = html.replace(/^# (.*$)/gm, (match, title) => '<h1 class="text-4xl font-bold mt-8 mb-6 text-solarized-base01 dark:text-dark-text tracking-tight font-sans">' + title + '</h1>');

            html = html.replace(/^-----$/gm, '<hr class="my-10 border-t-2 ' + (isDark ? 'border-dark-border' : 'border-solarized-base1/20') + '" />');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-solarized-base01 dark:text-dark-text">$1</strong>');

            // Fix list items to use theme colors and spacing
            html = html.replace(/<li>/g, '<li class="text-solarized-base00 dark:text-dark-muted font-serif mb-2 leading-relaxed">');
            html = html.replace(/<ul>/g, '<ul class="list-disc list-inside my-4 space-y-1">');
            html = html.replace(/<ol>/g, '<ol class="list-decimal list-inside my-4 space-y-1">');

            // Improved paragraph spacing and line height
            html = html.replace(/\n\n/g, '</div><div class="mb-6 leading-loose text-lg font-serif text-solarized-base00 dark:text-dark-muted">');
            html = html.replace(/\n/g, ' '); // Replace single newlines with space instead of br for better flow, unless it's a table/list

            return '<div class="mb-6 leading-loose text-lg font-serif text-solarized-base00 dark:text-dark-muted">' + html + '</div>';
        }

        function updateWelcomeMessage() {
            const msg = lectures.length > 0 ? lectures.length + ' lecture' + (lectures.length !== 1 ? 's' : '') + ' loaded. Select one to begin.' : 'No lectures loaded. Ensure lectures_data.js exists.';
            document.getElementById('welcomeMessage').textContent = msg;
        }
    </script>
</body>

</html>